///////////////////////////////////////////////////////////
//  Hra.cs
//  Implementation of the Class Hra
//  Generated by Enterprise Architect
//  Created on:      17-2-2016 17:13:21
//  Original author: Dobroslav Grygar
///////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.IO;
using System.Runtime.Serialization;
using System.Runtime.Serialization.Formatters.Binary;
using SimulacnaHra.gui;
using SimulacnaHra.prvkyHry.infrastruktura;
using SimulacnaHra.prvkyHry.mapa;
using SimulacnaHra.prvkyHry.vyroba;
using SimulacnaHra.spravaZvuku;

namespace SimulacnaHra.hra {

    /// <summary>
    /// Trieda ktor· m· na starosti priebeh hry
    /// udrûuje hern˙ plochu, poskytuje potrebnÈ sluûby
    /// </summary>
    [Serializable]
	public class Hra {

        private int aDen;
		private DateTime aDatum;
		private Spolocnost aSpolocnost;
		private List<Vyroba> aVyroba;
        private List<Mesto> aMesta;
        private HernaPlocha aHranaPlocha;
        private static Hra aInstanciaHry;
        //private OknoAplikacie aOkno;
        private const int cDlzkaDna = OknoAplikacie.cFPS*3;
        private int aPocetTikov;

        /// <summary>
        /// Vr·ti zoznam miest
        /// </summary>
        public List<Mesto> ZoznamMiest { get { return aMesta; } }
        /// <summary>
        /// Vr·ti aktu·lny deÚ
        /// </summary>
        public int Den { get { return aDen; } }
        /// <summary>
        /// Vr·ti spoloËnosù
        /// </summary>
        public Spolocnost Spolocnost { get { return aSpolocnost; } }
        /// <summary>
        /// Zoznam v˝roby
        /// </summary>
	    public List<Vyroba> ZoznamVyroby { get { return aVyroba; }}

        /// <summary>
        /// Konötruktor inicializuje vöetko potrebnÈ a p˙öùa hudbu
        /// </summary>
	    private Hra()
        {
            aSpolocnost = new Spolocnost("Transportna spolocnost");
            aHranaPlocha = new HernaPlocha();

            aMesta = new List<Mesto>();
            aVyroba = new List<Vyroba>();

            aMesta = aHranaPlocha.ZoznamMiest;
            aVyroba = aHranaPlocha.ZoznamVyroby;
            aDen = 0;
        }

        /// <summary>
        /// Vr·ti vlastn˙ inötanciu
        /// </summary>
        /// <returns></returns>
        public static Hra DajInstanciu() {
            if (aInstanciaHry == null) {
                aInstanciaHry = new Hra();
            }
            return aInstanciaHry;
        }

        /// <summary>
        /// 
        /// </summary>
		public void Nacitaj(){
            IFormatter formatter = new BinaryFormatter();
            Stream stream1 = new FileStream("save.bin", FileMode.Open, FileAccess.Read, FileShare.Read);
            aInstanciaHry = (Hra)formatter.Deserialize(stream1);
            stream1.Close();

            HernaPlocha.PocetStlpcov = aHranaPlocha.DajMaticu().GetLength(0);
            HernaPlocha.PocetRiadkov = aHranaPlocha.DajMaticu().GetLength(1);
		}

        /// <summary>
        /// Preruöenie hry
        /// </summary>
		public void Pauza(){

		}

        /// <summary>
        /// PokraËovanie hry
        /// </summary>
		public void Start(){


		}

        /// <summary>
        /// 
        /// </summary>
		public void Uloz()
        {
            IFormatter formatter = new BinaryFormatter();
            Stream stream = new FileStream("save.bin", FileMode.Create, FileAccess.Write, FileShare.None);
            formatter.Serialize(stream, aInstanciaHry);
            stream.Close();
		}

        /// <summary>
        /// Vr·ti hern˙ plochu
        /// </summary>
        /// <returns>hren· plocha</returns>
        public HernaPlocha DajHernuPlochu() {
            return aHranaPlocha;
        }

        /// <summary>
        /// Posiela spr·vy ûe preËla Ëasov· jednotka
        /// </summary>
        public void Tik() {
            aPocetTikov++;
            if (aPocetTikov == cDlzkaDna)
            {
                aDen++;
                aPocetTikov = 0;

                foreach (Mesto toto in aMesta)
                {
                    toto.PrechodDna();
                }

                foreach(Vyroba tato in aVyroba)
                {
                    tato.Vyrob();
                }
            }
        }
	}//end Hra

}//end namespace Hra